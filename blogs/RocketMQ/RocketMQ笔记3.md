---
title: RocketMQ笔记3
date: 2023-12-09
sidebar: 'auto'
categories: 
 - 后端
tags:
 - RocketMQ
---

[toc]

# RocketMQ笔记3

## 消息持久化

消息队列因为有高可靠性的要求，所以消息数据要进行持久化存储。

![rocketmq20221017163604](../blog_img/rocketmq20221017163604.png)

消息持久化的步骤
1. 生产者发送消息
2. MQ收到消息后，将消息进行持久化存储。
3. MQ存储消息之后，返回ACK给生产者。
4. MQ push消息给对应的消费者，然后等待消费者返回ACK
5. 如果消费者在指定时间内成功返回ack，那么MQ认为消息消费成功，在存储中删除持久化的消息，即执行第6步；如果MQ在指定时间内没有收到ACK，则认为消息消费失败，会尝试重新push消息,重复执行4、5、6步骤
6. MQ删除持久化存储的消息。

### 消息持久化的方式

RocketMQ的消息是持久化存储到磁盘上的，这样既能保证断电后恢复，又可以让存储的消息量超出内存的限制。

RocketMQ为了提高持久化的性能，会尽可能地保证磁盘的顺序写。生产者发送消息到RocketMQ的时候。有两种写磁盘方式，同步刷盘和异步刷盘。

![rocketmq20221017163852](../blog_img/rocketmq20221017163852.png)

> 同步刷盘

具体流程是，消息写入内存后，立刻通知刷盘线程刷盘。然后等待刷盘完成，刷盘线程执行完成后唤醒等待的线程，返回消息写成功的状态。

> 异步刷盘

具体流程是，消息写入内存后，会返回写成功状态。这时的消息会被暂时存储在内存中。当内存里的消息数量积累到一定程度时，统一触发写磁盘动作，快速写入。

> 如何配置写磁盘的方式

同步刷盘还是异步刷盘，都是通过Broker配置文件里的flushDiskType 参数设置的，这个参数被配置成SYNC_FLUSH(同步刷盘)、ASYNC_FLUSH(异步刷盘)。



